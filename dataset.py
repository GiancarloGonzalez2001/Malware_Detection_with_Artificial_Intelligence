
'''

******************************************************************
Rosario University                                               *
Forensics analysis and incident management                       *
Final project                                                    *
2021 - 2s                                                        *
                                                                 *
Giancarlo González                                               *
Ángel López                                                      *
******************************************************************

'''

# Se importan las librerias necesarias para crear el dataset
import os
import pefile
import glob

#se importan las librerias necesarias para analizar los datos y hacer claustering con k-means 
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
#------
from sklearn.cluster import KMeans
from sklearn.metrics import silhouette_score


#se abre el archivo en excel
csv = open('MalwareArtifacts.csv','w')

#Se escecifica la ruta de búsqueda del excel
files = glob.glob('/home/angel/Documentos/UR 2021-2/A. Forense/Proyecto Forense*')

#Se crean las cabecera del excel
csv.write("NombreArchivo,AddressOfEntryPoint,MajorLinkerVersion,MajorImageVersion,MajorOperatingSystemVersion,DllCharacteristics,SizeOfStackReserve,NumberOfSections,ResourceSize,\n")

#Se escriben los datos en el excel
for file in files:
    
    #se crea una lista que incluye nombres de archivos
    archivos = ["redbear.exe","ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa.exe","Procmon.exe"]
    
    # for que realiza el proceso de escritura en el excel de manera automática
    for i in range (len(archivos)):
        
        
        suspect_pe = pefile.PE(archivos[i])
        
        csv.write( str(archivos[i]) + ',') 
        csv.write( str(suspect_pe.OPTIONAL_HEADER.AddressOfEntryPoint) + ',')
        csv.write( str(suspect_pe.OPTIONAL_HEADER.MajorLinkerVersion) + ',')
        csv.write( str(suspect_pe.OPTIONAL_HEADER.MajorImageVersion) + ',')
        csv.write( str(suspect_pe.OPTIONAL_HEADER.MajorOperatingSystemVersion)+ ',')
        csv.write( str(suspect_pe.OPTIONAL_HEADER.DllCharacteristics) + ',')
        csv.write( str(suspect_pe.OPTIONAL_HEADER.SizeOfStackReserve) + ',')
        csv.write( str(suspect_pe.FILE_HEADER.NumberOfSections) + ',')
        csv.write( str(suspect_pe.OPTIONAL_HEADER.DATA_DIRECTORY[2].Size) + "\n")

csv.close() #se cierra el excel


malware_dataset = pd.read_csv('/home/angel/Documentos/UR 2021-2/A. Forense/Proyecto Forense/MalwareArtifacts.csv',
delimiter=',')

samples = malware_dataset.iloc[:, [1,2,3,4]].values
targets = malware_dataset.iloc[:, 8].values

k_means = KMeans(n_clusters=2,max_iter=300)
k_means.fit(samples)

print("K-means labels: " + str(k_means.labels_))
print ("\nK-means Clustering Results:\n\n", pd.crosstab(targets,
k_means.labels_,rownames = ["Observed"],colnames = ["Predicted"]) )
print ("\nSilhouette coefficient: %0.3f" % silhouette_score(samples,
k_means.labels_, metric='euclidean'))


print("Proceso de escritura exitoso") # mensaje de prueba
